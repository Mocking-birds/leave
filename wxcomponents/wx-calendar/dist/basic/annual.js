"use strict";var t=this&&this.__awaiter||function(t,_,l,r){return new(l=l||Promise)(function(i,e){function a(t){try{n(r.next(t))}catch(t){e(t)}}function s(t){try{n(r.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof l?e:new l(function(t){t(e)})).then(a,s)}n((r=r.apply(t,_||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnualPanelSwitch=void 0;let e=require("../interface/component"),r=require("./tools"),h=require("./constants"),o=require("../utils/shared"),{shared:c,timing:i,Easing:a}=wx.worklet,d="-150vh";class s extends e.CalendarHandler{constructor(t){super(t),this._interactive_callbacks_=[],this._transforming_=!1,this.skyline&&this.initialize()}initialize(){this._style_ids_=new Map,this.bindAnimations()}bindAnimations(){return t(this,void 0,void 0,function*(){let t=c(d),e=c(0),i=c(0),a=c(1);this._top_=t,this._opacity_=e,this._calendar_trans_=i,this._calendar_alpha_=a;var[s,n,_,l]=yield(0,o.promises)([(0,r.applyAnimated)(this._instance_,h.SELECTOR.ANNUAL,()=>{"worklet";return{top:t.value,opacity:e.value}}),(0,r.applyAnimated)(this._instance_,h.SELECTOR.CALENDAR,()=>{"worklet";return{opacity:1-e.value}}),(0,r.applyAnimated)(this._instance_,h.SELECTOR.PANEL_HEADER,()=>{"worklet";return{transform:`translateY(${-i.value}%)`,opacity:a.value}}),(0,r.applyAnimated)(this._instance_,h.SELECTOR.BAR,()=>{"worklet";return{transform:`translateY(${i.value}%)`,opacity:a.value}})]);this._style_ids_.set(h.SELECTOR.ANNUAL,s),this._style_ids_.set(h.SELECTOR.CALENDAR,n),this._style_ids_.set(h.SELECTOR.PANEL_HEADER,_),this._style_ids_.set(h.SELECTOR.BAR,l)})}showCalendar(){var t={duration:280,easing:a.out(a.sin)};this._calendar_trans_.value=i(0,t),this._calendar_alpha_.value=i(1,t)}hiddenCalendar(){this._calendar_trans_.value=200,this._calendar_alpha_.value=0}getCalendarRect(){return t(this,void 0,void 0,function*(){return(yield(0,r.nodeRect)(this._instance_)(h.SELECTOR.CALENDAR))[0]})}switch(a,s){return t(this,void 0,void 0,function*(){var e,i=this._instance_;if(!this._transforming_){this._transforming_=!0;let t=this.skyline;a?(yield i._panel_.toYear(s.year),e=yield this.getCalendarRect(),t?this._top_.value=`-${e.top}px`:i.setData({annualTop:0,annualDuration:300,annualOpacity:1}),yield(0,r.severalTicks)(10),yield i._printer_.open(s,e,()=>{t&&(this._opacity_.value=1)}),t&&this.hiddenCalendar()):(yield i._panel_.toAnnualMonth(s,i.$_gesture.value),yield(0,r.severalTicks)(10),yield i._printer_.close(s),t?this._opacity_.value=0:i.setData({annualOpacity:0}),t&&this.showCalendar(),yield(0,r.nextTick)(),t?this._top_.value=d:i.setData({annualTop:d})),this._transforming_=!1,this.execInteractiveCallbacks()}})}clearSkyline(){var t,e=this._instance_;null!=(t=this._style_ids_)&&t.has(h.SELECTOR.ANNUAL)&&(0,r.clearAnimated)(e,h.SELECTOR.ANNUAL,[this._style_ids_.get(h.SELECTOR.ANNUAL)]),null!=(t=this._style_ids_)&&t.has(h.SELECTOR.CALENDAR)&&(0,r.clearAnimated)(e,h.SELECTOR.CALENDAR,[this._style_ids_.get(h.SELECTOR.CALENDAR)]),null!=(t=this._style_ids_)&&t.has(h.SELECTOR.PANEL_HEADER)&&(0,r.clearAnimated)(e,h.SELECTOR.PANEL_HEADER,[this._style_ids_.get(h.SELECTOR.PANEL_HEADER)]),null!=(t=this._style_ids_)&&t.has(h.SELECTOR.BAR)&&(0,r.clearAnimated)(e,h.SELECTOR.BAR,[this._style_ids_.get(h.SELECTOR.BAR)]),null!=(t=this._style_ids_)&&t.clear(),this._style_ids_=void 0,this._opacity_=void 0,this._top_=void 0,this._calendar_trans_=void 0,this._calendar_alpha_=void 0}execInteractiveCallbacks(){for(;this._interactive_callbacks_.length;){var t=this._interactive_callbacks_.shift();(0,o.isFunction)(t)&&t()}}interaction(){return this._transforming_?new Promise(t=>{this._interactive_callbacks_.push(t)}):Promise.resolve()}}exports.AnnualPanelSwitch=s;